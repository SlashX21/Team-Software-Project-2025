# Grocery Guardian åç«¯åŠŸèƒ½éœ€æ±‚è¡¥å……æ–‡æ¡£

### 1. å†å²è®°å½•ç®¡ç†æ¥å£

#### 1.1 è·å–æ‰«æå†å²
```http
GET /history?userId={userId}&page={page}&size={size}
```

**è¯·æ±‚å‚æ•°:**
- `userId` (required): ç”¨æˆ·ID
- `page` (optional): é¡µç ï¼Œé»˜è®¤0
- `size` (optional): æ¯é¡µå¤§å°ï¼Œé»˜è®¤20

**å“åº”æ•°æ®:**
```json
{
  "content": [
    {
      "scanId": 123,
      "productName": "Coca Cola 330ml",
      "brand": "Coca-Cola",
      "barcode": "5000112548167",
      "scanTime": "2024-06-28T10:30:00Z",
      "allergenDetected": true,
      "actionTaken": "avoided",
      "analysis": {
        "isHealthy": false,
        "sugarContent": "35g per 330ml",
        "warnings": ["High sugar content"]
      }
    }
  ],
  "totalElements": 150,
  "totalPages": 8
}
```

**æ•°æ®åº“è¡¨:** `SCAN_HISTORY` + `PRODUCT`

#### 1.2 ä¿å­˜æ‰«æè®°å½•
```http
POST /history
```

**è¯·æ±‚ä½“:**
```json
{
  "userId": 1,
  "barcode": "5000112548167",
  "scanTime": "2024-06-28T10:30:00Z",
  "location": "Tesco Dublin",
  "allergenDetected": true,
  "actionTaken": "avoided"
}
```

**æ•°æ®åº“è¡¨:** `SCAN_HISTORY`

#### 1.3 è·å–å†å²ç»Ÿè®¡
```http
GET /history/statistics?userId={userId}&period={period}
```

**è¯·æ±‚å‚æ•°:**
- `period`: daily, weekly, monthly

**å“åº”æ•°æ®:**
```json
{
  "totalScans": 45,
  "productsAvoided": 12,
  "allergenWarnings": 8,
  "topCategories": [
    {"category": "Beverages", "count": 15},
    {"category": "Snacks", "count": 12}
  ],
  "nutritionTrends": {
    "avgCaloriesPerProduct": 250,
    "sugarIntakePattern": [10, 15, 8, 20, 5]
  }
}
```

### 2. ç”¨æˆ·è¿‡æ•åŸç®¡ç†æ¥å£

#### 2.1 è·å–ç”¨æˆ·è¿‡æ•åŸåˆ—è¡¨
```http
GET /user/{userId}/allergens
```

**å“åº”æ•°æ®:**
```json
{
  "userAllergens": [
    {
      "userAllergenId": 1,
      "allergenId": 3,
      "allergenName": "Milk",
      "category": "dairy",
      "severityLevel": "severe",
      "confirmed": true,
      "notes": "Causes digestive issues"
    }
  ]
}
```

**æ•°æ®åº“è¡¨:** `USER_ALLERGEN` + `ALLERGEN`

#### 2.2 æ·»åŠ ç”¨æˆ·è¿‡æ•åŸ
```http
POST /user/{userId}/allergens
```

**è¯·æ±‚ä½“:**
```json
{
  "allergenId": 3,
  "severityLevel": "moderate",
  "notes": "Mild reaction"
}
```

#### 2.3 åˆ é™¤ç”¨æˆ·è¿‡æ•åŸ
```http
DELETE /user/{userId}/allergens/{userAllergenId}
```

#### 2.4 è·å–æ‰€æœ‰è¿‡æ•åŸå­—å…¸
```http
GET /allergens
```

**å“åº”æ•°æ®:**
```json
{
  "allergens": [
    {
      "allergenId": 1,
      "name": "Gluten",
      "category": "grains",
      "isCommon": true,
      "description": "Found in wheat, barley, rye"
    }
  ]
}
```

### 3. ç”¨æˆ·åå¥½è®¾ç½®æ¥å£

#### 3.1 è·å–ç”¨æˆ·åå¥½
```http
GET /user/{userId}/preferences
```

**å“åº”æ•°æ®:**
```json
{
  "nutritionPreferences": {
    "preferLowSugar": true,
    "preferLowFat": false,
    "preferHighProtein": true,
    "preferLowSodium": true,
    "preferOrganic": false,
    "preferLowCalorie": true
  },
  "inferenceConfidence": 0.85,
  "version": 2
}
```

**æ•°æ®åº“è¡¨:** `USER_PREFERENCE`

#### 3.2 æ›´æ–°ç”¨æˆ·åå¥½
```http
PUT /user/{userId}/preferences
```

**è¯·æ±‚ä½“:**
```json
{
  "preferLowSugar": true,
  "preferLowFat": false,
  "preferHighProtein": true,
  "preferLowSodium": true,
  "preferOrganic": false,
  "preferLowCalorie": true,
  "preferenceSource": "user_manual"
}
```



### 4. ç³–åˆ†è¿½è¸ªæ¥å£

éœ€è¦æ–°å¢æ•°æ®åº“è¡¨:
```sql
CREATE TABLE SUGAR_INTAKE_HISTORY (
    intake_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    food_name VARCHAR(200) NOT NULL,
    sugar_amount_mg FLOAT NOT NULL,
    intake_time DATETIME NOT NULL,
    source_type ENUM('scan', 'manual', 'receipt') DEFAULT 'manual',
    barcode VARCHAR(255),
    serving_size VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES USER(user_id) ON DELETE CASCADE,
    FOREIGN KEY (barcode) REFERENCES PRODUCT(bar_code) ON DELETE SET NULL
);
```

#### 4.1 è·å–æ¯æ—¥ç³–åˆ†æ•°æ®
```http
GET /sugar-tracking/{userId}/daily?date={date}
```

**å“åº”æ•°æ®:**
```json
{
  "date": "2024-06-28",
  "currentIntakeMg": 25000,
  "dailyGoalMg": 30000,
  "progressPercentage": 83.3,
  "remainingMg": 5000,
  "status": "on_track",
  "topContributors": [
    {
      "foodName": "Coca Cola 330ml",
      "sugarAmount": 12000,
      "percentage": 48,
      "time": "14:30"
    },
    {
      "foodName": "Chocolate Bar",
      "sugarAmount": 8000,
      "percentage": 32,
      "time": "16:15"
    }
  ]
}
```

#### 4.2 æ·»åŠ ç³–åˆ†è®°å½•
```http
POST /sugar-tracking/{userId}/records
```

**è¯·æ±‚ä½“:**
```json
{
  "foodName": "Apple Juice 250ml",
  "sugarAmount": 22000,
  "intakeTime": "2024-06-28T15:30:00Z",
  "sourceType": "scan",
  "barcode": "1234567890123",
  "servingSize": "250ml"
}
```

#### 4.3 è®¾ç½®ç³–åˆ†ç›®æ ‡
```http
POST /sugar-tracking/{userId}/goals
```

**è¯·æ±‚ä½“:**
```json
{
  "dailyGoalMg": 25000
}
```

#### 4.4 è·å–æœˆåº¦ç³–åˆ†ç»Ÿè®¡
```http
GET /sugar-tracking/{userId}/monthly?month={yyyy-MM}
```

**å“åº”æ•°æ®:**
```json
{
  "month": "2024-06",
  "averageDailyIntake": 28500,
  "goalAchievementRate": 0.75,
  "totalDaysTracked": 20,
  "dailyData": [
    {
      "date": "2024-06-01",
      "intake": 32000,
      "goal": 30000,
      "exceeded": true
    }
  ],
  "trends": {
    "improvingDays": 15,
    "worseningDays": 5,
    "peakIntakeDay": "2024-06-15",
    "bestDay": "2024-06-22"
  }
}
```

#### 4.5 åˆ é™¤ç³–åˆ†è®°å½•
```http
DELETE /sugar-tracking/{userId}/records/{intakeId}
```

### 5. äº§å“æœç´¢æ¥å£

#### 5.1 æŒ‰åç§°æœç´¢äº§å“
```http
GET /product/search?name={productName}&page={page}&size={size}
```

**å“åº”æ•°æ®:**
```json
{
  "products": [
    {
      "barcode": "5000112548167",
      "productName": "Coca Cola Original 330ml",
      "brand": "Coca-Cola",
      "category": "Beverages",
      "energyKcal100g": 42,
      "sugars100g": 10.6,
      "matchScore": 0.95
    }
  ],
  "totalElements": 25
}
```

#### 5.2 æŒ‰ç±»åˆ«è·å–äº§å“
```http
GET /product/category/{category}?page={page}&size={size}
```

#### 5.3 æŒ‰è¥å…»æˆåˆ†ç­›é€‰
```http
GET /product/filter?maxCalories={cal}&maxSugar={sugar}&minProtein={protein}
```

### 6. äº§å“åå¥½ç®¡ç†

#### 6.1 è®¾ç½®äº§å“åå¥½
```http
POST /user/{userId}/product-preferences
```

**è¯·æ±‚ä½“:**
```json
{
  "barcode": "5000112548167",
  "preferenceType": "dislike",
  "reason": "Too much sugar for my diet"
}
```

**æ•°æ®åº“è¡¨:** `PRODUCT_PREFERENCE`

#### 6.2 è·å–ç”¨æˆ·äº§å“åå¥½
```http
GET /user/{userId}/product-preferences?type={like|dislike|blacklist}
```

### 7. è¥å…»ç›®æ ‡ç®¡ç†

#### 7.1 è®¡ç®—ç”¨æˆ·æ¯æ—¥è¥å…»éœ€æ±‚
```http
GET /user/{userId}/nutrition-requirements
```

**å“åº”æ•°æ®:**
```json
{
  "dailyRequirements": {
    "calories": 2200,
    "protein": 165,
    "carbohydrates": 275,
    "fat": 73,
    "sugar": 30,
    "fiber": 25,
    "sodium": 2300
  },
  "calculationBasis": {
    "bmr": 1800,
    "activityMultiplier": 1.55,
    "goalAdjustment": -300
  }
}
```

#### 7.2 æ›´æ–°è¥å…»ç›®æ ‡
```http
PUT /user/{userId}/nutrition-goals
```

### 8. é«˜çº§æ¨èåŠŸèƒ½

#### 8.1 åŸºäºè´­ä¹°å†å²çš„æ¨è
```http
POST /recommendations/history-based
```

**è¯·æ±‚ä½“:**
```json
{
  "userId": 1,
  "analysisType": "weekly_pattern",
  "includeAlternatives": true
}
```

#### 8.2 è¥å…»äº’è¡¥æ¨è
```http
POST /recommendations/nutritional-complement
```

**è¯·æ±‚ä½“:**
```json
{
  "userId": 1,
  "currentProducts": ["5000112548167", "1234567890123"],
  "mealType": "breakfast"
}
```

### 9. æ•°æ®å¯¼å‡ºåŠŸèƒ½

#### 9.1 å¯¼å‡ºç”¨æˆ·æ•°æ®
```http
GET /user/{userId}/export?format={json|csv}&type={all|nutrition|history}
```

#### 9.2 ç”Ÿæˆè¥å…»æŠ¥å‘Š
```http
GET /user/{userId}/nutrition-report?period={weekly|monthly}&format={pdf|json}
```

---

## ğŸ›  æŠ€æœ¯å®ç°å»ºè®®

### æ•°æ®åº“ä¿®æ”¹éœ€æ±‚

1. **æ–°å¢è¡¨:**
   ```sql
   -- ç³–åˆ†æ‘„å…¥å†å²è¡¨
   CREATE TABLE SUGAR_INTAKE_HISTORY (...);
   
   -- è¥å…»ç›®æ ‡è¿½è¸ªè¡¨
   CREATE TABLE NUTRITION_TRACKING (...);
   
   -- ç”¨æˆ·é€šçŸ¥è®¾ç½®è¡¨
   CREATE TABLE USER_NOTIFICATION_SETTINGS (...);
   ```

2. **å­—æ®µè¡¥å……:**
   ```sql
   -- PRODUCTè¡¨æ·»åŠ å›¾ç‰‡URL
   ALTER TABLE PRODUCT ADD COLUMN image_url VARCHAR(500);
   
   -- USERè¡¨æ·»åŠ æœ€åç™»å½•æ—¶é—´
   ALTER TABLE USER ADD COLUMN last_login_time DATETIME;
   ```

### APIè®¾è®¡è§„èŒƒ

1. **ç»Ÿä¸€å“åº”æ ¼å¼:**
   ```json
   {
     "success": true,
     "data": {...},
     "message": "æ“ä½œæˆåŠŸ",
     "timestamp": "2024-06-28T10:30:00Z"
   }
   ```

2. **é”™è¯¯å¤„ç†:**
   ```json
   {
     "success": false,
     "error": {
       "code": "USER_NOT_FOUND",
       "message": "ç”¨æˆ·ä¸å­˜åœ¨",
       "details": "userId: 999 not found in database"
     },
     "timestamp": "2024-06-28T10:30:00Z"
   }
   ```

3. **åˆ†é¡µå“åº”:**
   ```json
   {
     "success": true,
     "data": {
       "content": [...],
       "totalElements": 100,
       "totalPages": 10,
       "currentPage": 0,
       "size": 10
     }
   }
   ```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç¼“å­˜ç­–ç•¥:**
   - äº§å“ä¿¡æ¯Redisç¼“å­˜ (TTL: 1å°æ—¶)
   - ç”¨æˆ·åå¥½ç¼“å­˜ (TTL: 30åˆ†é’Ÿ)
   - è¿‡æ•åŸå­—å…¸ç¼“å­˜ (TTL: 24å°æ—¶)

2. **æ•°æ®åº“ä¼˜åŒ–:**
   - æ·»åŠ å¤åˆç´¢å¼•: `(user_id, scan_time)`
   - å†å²æ•°æ®åˆ†åŒºå­˜å‚¨ (æŒ‰æœˆåˆ†åŒº)
   - è¥å…»æ•°æ®é¢„è®¡ç®—

3. **APIé™æµ:**
   - ç”¨æˆ·çº§åˆ«: 1000æ¬¡/å°æ—¶
   - æ‰«ææ¥å£: 60æ¬¡/åˆ†é’Ÿ
