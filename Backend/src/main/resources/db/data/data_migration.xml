<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <!-- 1. 导入过敏原数据 -->
    <changeSet id="load-allergen-data-from-csv" author="TPZ">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="allergen"/>
            <sqlCheck expectedResult="0">SELECT COUNT(*) FROM allergen</sqlCheck>
        </preConditions>
        
        <comment>从CSV文件导入过敏原字典数据</comment>
        
        <loadData file="db/data/allergen_dictionary.csv"
                  tableName="allergen"
                  separator=","
                  quotchar="&quot;">
            <column name="allergen_id" type="NUMERIC"/>
            <column name="name" type="STRING"/>
            <column name="category" type="STRING"/>
            <column name="is_common" type="BOOLEAN"/>
            <column name="description" type="STRING"/>
        </loadData>
        
        <rollback>
            <delete tableName="allergen"/>
        </rollback>
    </changeSet>

    <!-- 2. 导入产品数据 -->
    <changeSet id="load-product-data-from-csv" author="TPZ">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="product"/>
            <sqlCheck expectedResult="0">SELECT COUNT(*) FROM product</sqlCheck>
        </preConditions>
        
        <comment>从CSV文件导入产品数据</comment>
        
        <loadData file="db/data/ireland_products_final.csv"
                  tableName="product"
                  separator=","
                  quotchar="&quot;">
            <!-- 字段映射 -->
            <column name="bar_code" header="barcode" type="STRING"/>
            <column name="product_name" header="name" type="STRING"/>
            <column name="brand" header="brand" type="STRING"/>
            <column name="ingredients" header="ingredients" type="STRING"/>
            <column name="allergens" header="allergens" type="STRING"/>
            <column name="energy_100g" header="energy_100g" type="NUMERIC"/>
            <column name="energy_kcal_100g" header="energy_kcal_100g" type="NUMERIC"/>
            <column name="fat_100g" header="fat_100g" type="NUMERIC"/>
            <column name="saturated_fat_100g" header="saturated_fat_100g" type="NUMERIC"/>
            <column name="carbohydrates_100g" header="carbohydrates_100g" type="NUMERIC"/>
            <column name="sugars_100g" header="sugars_100g" type="NUMERIC"/>
            <column name="proteins_100g" header="proteins_100g" type="NUMERIC"/>
            <column name="serving_size" header="serving_size" type="STRING"/>
            <column name="category" header="category" type="STRING"/>
            <column name="created_at" defaultValueDate="CURRENT_TIMESTAMP" type="TIMESTAMP"/>
            <column name="updated_at" defaultValueDate="CURRENT_TIMESTAMP" type="TIMESTAMP"/>
        </loadData>
        
        <rollback>
            <delete tableName="product"/>
        </rollback>
    </changeSet>

    <!-- 3. 数据验 -->
    <changeSet id="validate-migrated-data" author="TPZ">
        <comment>验证迁移的数据</comment>
        <sql>
            -- 检查过敏原数据
            SELECT 'Allergen count:' as info, COUNT(*) as count FROM allergen;
            
            -- 检查产品数据
            SELECT 'Product count:' as info, COUNT(*) as count FROM product;
            
            -- 检查产品分类分布
            SELECT category, COUNT(*) as count FROM product GROUP BY category;
        </sql>
    </changeSet>

</databaseChangeLog>